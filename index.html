<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Painel - Frota (GViz)</title>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<style>
:root{
  --bg:#071029;
  --card:#2a71e8;
  --muted:#f7f9fa;
  --accent:#00eaff;
}

html,body{
  height:100%;
  margin:0;
  background:var(--bg);
  color:#fff;
  font-family:Inter,Arial;
}

header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px 80px;
  background:#020617;
  border-radius:10px;
}

header img{height:70px}
header .title{font-size:30px;font-weight:700;color:var(--accent)}
header .clock{font-size:26px;color:var(--muted)}

main{
  padding:12px;
  display:grid;
  grid-template-rows:1fr 1fr 1fr;
  gap:10px;
  height:calc(100vh - 92px);
}

.card{
  background:var(--card);
  border-radius:10px;
  padding:12px;
  overflow:auto;
}

.card h2{
  margin:0 0 8px;
  color:var(--accent);
  font-size:26px;
  text-align:center;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:16px;
}

th,td{
  padding:12px 36px;
  border-radius:10px;
  font-weight:700;
  text-align:center;
  white-space:nowrap;
}

thead th{
  position:sticky;
  top:0;
  background:#0435bf;
  z-index:2;
}

th:last-child,
td:last-child{
  width:50px;
}

td.status-icon{
  font-size:20px;
}
  /* ================= CORES DE STATUS ================= */
tr.status-atendido   td.status-icon{color:#00ff9c;}
tr.status-cancelado  td.status-icon{color:#ff4d4d;}
tr.status-andamento  td.status-icon{color:#ffcc00;}
tr.status-concluido  td.status-icon{color:#7CFC00;}
 
tr.status-atendido{background:rgba(147,219,112,0.18)}
tr.status-andamento{background:rgba(219,147,112,0.18)}
tr.status-concluido{background:rgba(0,200,120,0.10)}

.small{
  text-align:center;
  font-size:12px;
  color:var(--muted);
}
</style>
</head>

<body>

  <audio id="beep" preload="auto">
  <source src="alerta.mp3" type="audio/mpeg">
</audio>

<header>
  <img src="logo.png" onerror="this.style.display='none'">
  <div class="title">MOVIMENTA√á√ÉO DI√ÅRIA</div>
  <div class="clock" id="clock"></div>
</header>

<main>
  <section class="card">
    <h2>PAINEL</h2>
    <div id="painel">Carregando...</div>
  </section>

  <section class="card">
    <h2>AGENDA DO DIA</h2>
    <div id="agenda">Carregando...</div>
  </section>

  <section class="card">
    <h2>AGENDA SERVI√áO SOCIAL</h2>
    <div id="social">Carregando...</div>
  </section>
</main>

<div class="small">Atualiza√ß√£o autom√°tica a cada 60s ‚Ä¢ Google Sheets</div>




<script>
/* ================= CONFIG ================= */
const SHEET_ID = "1Ch3AjQ0MDo4WuQWFDR3r8nZrHb4yQkSLOtT5_QgxT6E";
const TABS = [
  { id:"painel", name:"PAINEL" },
  { id:"agenda", name:"AGENDA DO DIA" },
  { id:"social", name:"AGENDA SERVI√áO SOCIAL" }
];

/* ================= HEADERS ================= */
const TABLE_HEADERS = {
  painel: ["Data","Hora","Ve√≠culo","Empregado","Passageiro/Motivo","Itiner√°rio","STATUS"],
  agenda: ["Data","Hora","Passageiro","Setor","Motivo","Itiner√°rio","STATUS"],
  social: ["Data","Per√≠odo","Passageiro","Motivo","Itiner√°rio","STATUS"]
};

/* ================= √ÅUDIO ================= */
let audioUnlocked = false;
let lastDataHash = null;
let firstLoad = true;

function playBeep(){
  const a = document.getElementById("beep");
  if(!a || !audioUnlocked) return;
  a.currentTime = 0;
  a.play().catch(()=>{});
}

/* üîì desbloqueio por clique */
document.addEventListener("click", () => {
  const a = document.getElementById("beep");
  if(!a || audioUnlocked) return;

  a.volume = 0.6;
  a.play().then(()=>{
    a.pause();
    a.currentTime = 0;
    audioUnlocked = true;
    console.log("üîä √°udio liberado");
  }).catch(()=>{});
},{ once:true });

/* ================= REL√ìGIO ================= */
function updateClock(){
  const n = new Date();
  document.getElementById("clock").innerText =
    n.toLocaleDateString("pt-BR")+" ‚Äî "+
    n.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});
}
setInterval(updateClock,1000);
updateClock();

/* ================= HELPERS ================= */
const parseGviz = t =>
  JSON.parse(t.substring(t.indexOf("{"), t.lastIndexOf("}") + 1));

const escapeHtml = s =>
  String(s ?? "").replace(/[&<>]/g,m=>({
    "&":"&amp;","<":"&lt;",">":"&gt;"
  }[m]));

const formatCell = c =>
  c == null ? "" : (typeof c === "object" ? (c.f ?? c.v ?? "") : String(c));

/* üîê hash apenas com valores reais */
function generateCleanHash(results){
  return JSON.stringify(
    results.map(r =>
      r.table.rows.map(row =>
        (row.c || []).map(c => c?.f ?? c?.v ?? "")
      )
    )
  );
}

/* ================= RENDER ================= */
function renderTable(id, g){
  const el = document.getElementById(id);
  if(!g?.table?.rows){
    el.innerHTML = "<div style='text-align:center;opacity:.7'>Sem dados</div>";
    return;
  }

  const headers = TABLE_HEADERS[id] || [];
  const rows = g.table.rows;

  let h="<table><thead><tr>";
  headers.forEach(c=>h+=`<th>${escapeHtml(c)}</th>`);
  h+="</tr></thead><tbody>";

  rows.forEach(r=>{
    const cells=r.c||[];
    const status=String(cells.at(-1)?.f ?? cells.at(-1)?.v ?? "").toLowerCase();

    let cls="";
    if(status.includes("cancelado")) cls="status-cancelado";
    else if(status.includes("concluido")) cls="status-concluido";
    else if(status.includes("andamento")) cls="status-andamento";
    else if(status.includes("atendido")) cls="status-atendido";

    h+=`<tr class="${cls}">`;

    cells.forEach((c,i)=>{
      if(i === cells.length-1){
        let icon="";
        if(status.includes("concluido")||status.includes("atendido")) icon="‚úî";
        if(status.includes("cancelado")) icon="‚úñ";
        else if(status.includes("andamento")) icon="‚è≥";
        h+=`<td class="status-icon">${icon}</td>`;
      }else{
        h+=`<td>${escapeHtml(formatCell(c))}</td>`;
      }
    });

    h+="</tr>";
  });

  h+="</tbody></table>";
  el.innerHTML=h;
}

/* ================= FETCH ================= */
async function fetchSheet(tab){
  const url =
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq`+
    `?sheet=${encodeURIComponent(tab)}&tqx=out:json&nocache=${Date.now()}`;

  const r = await fetch(url,{cache:"no-store"});
  return parseGviz(await r.text());
}

/* ================= LOAD ================= */
async function loadAll(){
  try{
    const results = await Promise.all(TABS.map(t=>fetchSheet(t.name)));

    const currentHash = generateCleanHash(results);

    if(!firstLoad && lastDataHash && currentHash !== lastDataHash){
      playBeep(); // üîä SOM S√ì SE DADOS MUDAREM
    }

    firstLoad = false;
    lastDataHash = currentHash;

    renderTable("painel", results[0]);
    renderTable("agenda", results[1]);
    renderTable("social", results[2]);

  }catch(e){
    console.error(e);
  }
}

loadAll();
setInterval(loadAll, 10000);
</script>
