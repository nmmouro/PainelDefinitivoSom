<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Painel - Frota (GViz)</title>

<!-- evitar cache no GitHub Pages -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<style>
:root{
  --bg:#071029;
  --card:#2a71e8;
  --muted:#f7f9fa;
  --accent:#00eaff;
  --danger:#9b1111;
  --cabe√ßalho:#0037ff;
}

html,body{
  height:100%;
  margin:0;
  background:var(--bg);
  color:#fff;
  font-family:Inter,Arial;
}

/* ================= HEADER ================= */
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px 80px;
  background:#020617;
  border-bottom:1px solid rgba(255,255,255,0.03);
  border-radius:10px;
}

header img{height:66px}
header .title{font-size:24px;font-weight:700;color:var(--accent)}
header .clock{font-size:20px;color:var(--muted)}

/* ================= LAYOUT ================= */
main{
  padding:12px;
  display:grid;
  grid-template-rows:1fr 1fr 1fr;
  gap:10px;
  height:calc(100vh - 92px);
  box-sizing:border-box;
}

.card{
  background:var(--card);
  border-radius:10px;
  padding:12px;
  overflow:auto;
}

/* ================= T√çTULOS ================= */
.card h2{
  margin:1 1 8px;
  color:var(--accent);
  font-size:18px;
  text-align:center;
}

/* ================= TABELA ================= */
table{
  width:100%;
  border-collapse:collapse;
  font-size:16px;
}

/* üîπ CENTRALIZA TODO O TEXTO */
th, td{
  padding:12px 16px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  font-weight:700;
  text-align:center;
  vertical-align:middle;
}

/* ================= CABE√áALHO ================= */
thead th{
  position:sticky;
  top:0;
  z-index:1000;
  background:#0435bf;
  padding:10px;
  text-align:center;
}

thead th:first-child{border-top-left-radius:12px}
thead th:last-child{border-top-right-radius:12px}

/* ================= √öLTIMA COLUNA (STATUS) ================= */
th:last-child,
td:last-child{
  border-right:none;
  width:50px;
  text-align:center;
}

/* ================= STATUS ICON ================= */
td.status-icon{
  text-align:center;
  font-size:20px;
  font-weight:bold;
  vertical-align:middle;
}

/* ================= CORES DE STATUS ================= */
tr.status-atendido   td.status-icon{color:#00ff9c;}
tr.status-cancelado  td.status-icon{color:#ff4d4d;}
tr.status-andamento  td.status-icon{color:#ffcc00;}
tr.status-concluido  td.status-icon{color:#7CFC00;}

tr.status-andamento{background:rgba(219,147,112,0.18)}
tr.status-atendido{background:rgba(147,219,112,0.18)}
tr.status-concluido{background:rgba(0,200,120,0.06)}

/* ================= RODAP√â ================= */
.small{
  font-size:12px;
  color:var(--muted);
  text-align:center;
  margin-top:6px;
}

/* ================= LARGURAS OPCIONAIS ================= */
.col-xs{width:50px;max-width:50px}
.col-sm{width:80px;max-width:80px}
.col-md{width:140px;max-width:140px}
.col-lg{width:220px;max-width:220px}
.col-xl{width:320px;max-width:320px}

</style>
</head>

<body>

<header>
  <img src="logo.png" alt="Logo" onerror="this.style.display='none'">
  <div class="title">MOVIMENTA√á√ÉO DI√ÅRIA</div>
  <div class="clock" id="clock">--:--</div>
</header>

<main>
  <section class="card">
    <h2>PAINEL</h2>
    <div id="painel">Carregando...</div>
  </section>

  <section class="card">
    <h2>AGENDA DO DIA</h2>
    <div id="agenda">Carregando...</div>
  </section>

  <section class="card">
    <h2>AGENDA SERVI√áO SOCIAL</h2>
    <div id="social">Carregando...</div>
  </section>
</main>

<div class="small">
  Atualiza√ß√£o autom√°tica a cada 60s ‚Ä¢ Fonte: Google Sheets (GViz)
</div>

<script>
/* ================= CONFIG ================= */
const SHEET_ID = "1Ch3AjQ0MDo4WuQWFDR3r8nZrHb4yQkSLOtT5_QgxT6E";
const TAB_PAINEL = "PAINEL";
const TAB_AGENDA = "AGENDA DO DIA";
const TAB_SS = "AGENDA SERVI√áO SOCIAL";

/* ================= REL√ìGIO ================= */
function updateClock(){
  const n = new Date();
  document.getElementById("clock").innerText =
    n.toLocaleDateString("pt-BR") + " ‚Äî " + n.toLocaleTimeString("pt-BR");
}
setInterval(updateClock,1000);
updateClock();

/* ================= HELPERS ================= */
function parseGvizText(text){
  return JSON.parse(text.substring(text.indexOf("{"), text.lastIndexOf("}")+1));
}
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>]/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;" }[m]));
}
function formatCell(cell){
  if (cell === null || cell === undefined) return "";

  // objeto GViz
  if (typeof cell === "object"){
    if (cell.f !== undefined && cell.f !== null) return String(cell.f);
    if (cell.v !== undefined && cell.v !== null) return formatCell(cell.v);
    return ""; // ‚úÖ evita [object Object]
  }

  return String(cell);
}

/* ================= RENDER ================= */
function renderTable(containerId, g){
  const container=document.getElementById(containerId);
  if(!g?.table?.cols){
    container.innerHTML="<div style='text-align:center;opacity:.7'>Sem dados</div>";
    return;
  }

  const cols=g.table.cols.map(c=>c.label||"");
  const rows=g.table.rows||[];

  let html="<table><thead><tr>";
  cols.forEach(h=>html+=`<th>${escapeHtml(h)}</th>`);
  html+="</tr></thead><tbody>";

  rows.forEach(r=>{
    const cells=r.c||[];
    const last=cells[cells.length-1];
    const status=String(last?.f??last?.v??"").toLowerCase();

    let cls="";
    if(status.includes("cancelado"))cls="status-cancelado";
    else if(status.includes("concluido"))cls="status-concluido";
    else if(status.includes("andamento"))cls="status-andamento";
    else if(status.includes("atendido"))cls="status-atendido";

    html+=`<tr class="${cls}">`;

    cells.forEach((c,i)=>{
      const raw=formatCell(c);
      if(i===cells.length-1){
        if(status.includes("concluido")||status.includes("atendido"))
          html+=`<td class="status-icon">‚úî</td>`;
        else if(status.includes("cancelado"))
          html+=`<td class="status-icon">‚úñ</td>`;
        else if(status.includes("andamento"))
          html+=`<td class="status-icon">‚è≥</td>`;
        else
          html+=`<td>${escapeHtml(raw)}</td>`;
      }
       else{
          html += `<td>${escapeHtml(raw)}</td>`;
      }

    });

    html+="</tr>";
  });

  html+="</tbody></table>";
  container.innerHTML=html;
}

/* ================= FETCH ================= */
async function fetchSheet(tab){
  const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(tab)}&tqx=out:json&nocache=${Date.now()}`;
  const r=await fetch(url,{cache:"no-store"});
  return parseGvizText(await r.text());
}

/* ================= LOAD ================= */
async function loadAll(){
  try{
    const [p,a,s]=await Promise.all([
      fetchSheet(TAB_PAINEL),
      fetchSheet(TAB_AGENDA),
      fetchSheet(TAB_SS)
    ]);
    renderTable("painel",p);
    renderTable("agenda",a);
    renderTable("social",s);
  }catch(e){
    console.error("Erro GViz:",e);
  }
}

loadAll();
setInterval(loadAll,60000);
</script>

</body>
</html>
